language: node_js
os: linux
dist: xenial
node_js: [14]

cache:
  npm: true
  directories:
    - $HOME/.cache

addons:
  apt:
    packages:
      # Ubuntu 16+ does not install this dependency by default, so we need to install it ourselves
      - libgconf-2-4

if: tag IS present OR commit_message !~ /^chore(release)/

install:
  - yarn

jobs:
  include:
    - stage: test
      if: tag !~ @appland/.+-v\d\.\d\.\d
      script: yarn run ci

    - stage: deploy
      if: tag IS NOT present AND branch != main
      script: yarn run build && yarn run chromatic

    - stage: deploy
      if: tag IS NOT present AND branch = main
      script: |
        yarn run build \
        && yarn run chromatic --auto-accept-changes \
        && yarn run semantic-release

    - stage: deploy
      if: tag =~ @appland/.+-v\d\.\d\.\d
      script: yarn run build && ./bin/publish
