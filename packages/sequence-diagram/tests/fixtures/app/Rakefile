#!/usr/bin/env ruby

def run_program(command)
  puts command
  system command or raise "Command failed: #{command}"
end

task :build do
  Dir['bin/*.rb'].each do |test_program|
    run_program %(bundle exec ruby #{test_program})
  end
  appmaps = Dir['tmp/appmap/*.appmap.json']
  Dir.chdir '../../../../cli' do
    run_program %(node ./built/cli.js index --appmap-dir ../sequence-diagram/tests/fixtures/app/tmp/appmap)
    %w{json plantuml}.each do |format|
      appmaps.each do |appmap|
        run_program %(node ./built/cli.js sequence-diagram -d ../sequence-diagram/tests/fixtures/app --format #{format} #{appmap})
      end
    end
  end
  run_program %(java -jar ../plantuml-1.2022.8.jar -tsvg tmp/appmap/*.uml)
end

task default: :build
