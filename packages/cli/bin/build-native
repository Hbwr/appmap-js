#!/bin/bash
set -e

echo "Building native binaries..."
yarn pkg \
  --config package.json \
  --compress GZip \
  -o release/appmap \
  built/cli.js

echo "Archiving..."
pushd release>/dev/null
  rm -rf *.tar.gz
  for i in appmap-*; do
    archive_name="$(echo ${i} | sed 's/\..*//').tar.gz"
    tar \
      --transform 's|-\w*||' \
      -czf "${archive_name}" \
      "${i}"
    echo "  + ${archive_name}"
  done
popd>/dev/null

echo "Success!"